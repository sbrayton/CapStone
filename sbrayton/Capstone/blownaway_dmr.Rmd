---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
setwd("/Users/shamekabrayton/Dropbox/NYU/02_Module/07_Data Decision Data Making/Exam")
pacman::p_load(DBI,rJava,tidyr,RJDBC,RMySQL, ggplot2,  reader, forcats, DT, broom, tidyverse, shiny, dplyr,dbplyr,stringr, sjPlot, sjmisc, questionr, stargazer, rio, ggeffects, FSelector)
```



```{r}
#setting up the connection string to the database

mySqlCreds <- list(dbhostname = "52.203.27.250",
               dbname   = "blownAway",
               username = "BlownAway",
               pass = "blownAway123!",
               port = 3306
                 )
drv <- dbDriver("MySQL")

```


```{r}
#pull data from the table into a variable 
#connection string to the database
con<-dbConnect(drv, host=mySqlCreds$dbhostname, dbname=mySqlCreds$dbname, 
        user=mySqlCreds$username, password=mySqlCreds$pass, port = mySqlCreds$port)

sql<-("select * from blownAway.yr_2017 limit 10")
# 
#  rs <- dbSendQuery(con, sql)
# ds<- dbFetch(rs)
#  dbDisconnect(con)
 
# db_2017 <- tbl(con ,sql("select * from blownAway.yr_2017"))
db_2017 <- tbl(con ,sql("
select b.ballhandler_id
,`False`
,`True`
,`NA`
,`Total Access`
from `blownAway`.`yr_2017` as b
left join (
	select   ballhandler_id,count(*) as `False` from `blownAway`.`yr_2017`
	where shot_result='False' 	group by ballhandler_id
	)f on f.ballhandler_id = b.ballhandler_id
left join (
	select   ballhandler_id,count(*) as `True` from `blownAway`.`yr_2017`
	where shot_result='True' 	group by ballhandler_id
	)t on t.ballhandler_id = b.ballhandler_id
left join (
	select   ballhandler_id,count(*) as `NA` from `blownAway`.`yr_2017`
	where shot_result='NA' 	group by ballhandler_id
	)na   on na.ballhandler_id = b.ballhandler_id
left join (
	select   ballhandler_id,count(*)as `Total Access` from `blownAway`.`yr_2017` 	group by ballhandler_id
	)a on a.ballhandler_id = b.ballhandler_id

group by b.ballhandler_id,`False`,`True`,`NA` ,`Total Access`                        "))


db_2017<- as.data.frame(db_2017)
# db_2017$led_to_shot<-as.factor(db_2017$led_to_shot)
# db_2017$shot_result<-as.factor(db_2017$shot_result)

str(db_2017) 

View(db_2017)
 


```

```{r}
 #porb. of make a shot successfully ~ number of passes in posession+time on clock+distance from basket

clock_shot <- subset(db_2017,  select = c("start_shot_clock", "shot_result"))

baller_shot <- subset(db_2017, shot_result != "NA", select = c("ballhandler_id", "shot_result"))


str(baller_shot)

plot(baller_shot)

baller_shot$shot_resultasNum<-as.numeric(baller_shot$shot_result)

baller_shot <- baller_shot[complete.cases(baller_shot), ]

plot(baller_shot$ballhandler_id~baller_shot$shot_result, xlab='shot_result', ylab='baller_shot', main='Boxplots of Age by Race')

summary(lm(baller_shot$ballhandler_id~baller_shot$shot_result, data=baller_shot))

agg.count <- aggregate(baller_shot$shot_result ~ baller_shot$ballhandler_id, baller_shot, FUN="length")


baller_shot %>% 
    select( baller_shot$ballhandler_id, baller_shot$shot_result) %>%
    filter(baller_shot$shot_result == 'TRUE')

baller_shot %>% 
    group_by(ballhandler_id) %>%
  summarise_each(funs(t.test(.[vs == 0], .[vs == 1])$p.value), vars = disp:qsec)
  
    summarise(cntTrue = length(baller_shot$shot_result[baller_shot$shot_result=="True"]))

 p<-   baller_shot %>% group_by(baller_shot$ballhandler_id, baller_shot$shot_result) %>% mutate(count = n())
 
 p[(p$ballhandler_id)=='399612',]
    
length(baller_shot$shot_result[baller_shot$shot_result=="False"])


noNA.ins <- na.omit(baller_shot) # Option 1 

nrow(noNA.ins[!complete.cases(noNA.ins),])

#how many passes within a cycle for a player resulting in the shot, average?
#as a predictor use the how many hands in a cycle can predict a successful shot
#difference or distribution, of time between each pass in a cycle
# 


```

```{r}


shoot <- tbl(con ,sql("select * from blownAway.yr_2017"))
shoot<-as.data.frame(shoot)

offense <- as.data.frame(cbind(chance_id=(shoot$chance_id),
                        ballhandler_id=(shoot$ballhandler_id),
                         defender_id=(shoot$defender_id),
                         start_shot_clock=(shoot$start_shot_clock),
                         basket_distance=(shoot$basket_distance),
                         led_to_shot=(shoot$let_to_shot),
                         shot_result=(shoot$shot_result)
))

offense <- na.omit(offense)

offense$shot_result_num <- as.numeric(offense$shot_result)
offense$shot_result_num[offense$shot_result_num==1] <- 0
offense$shot_result_num[offense$shot_result_num==2] <- 1

```

```{r}

sp<-offense%>% 
  group_by(ballhandler_id)%>% 
  summarise(shot_percentage=mean(shot_result_num))

```

